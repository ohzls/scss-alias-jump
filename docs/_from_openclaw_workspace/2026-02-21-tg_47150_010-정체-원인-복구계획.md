# tg_47150_010 정체 원인/복구 계획 문서 (2026-02-21)

## 1) 문제 요약
- 현상: `predict_visitors.py --id tg_47150_010` 실행 시 아래 메시지로 실패
  - `해당 관광지(tg_47150_010)는 아직 학습한 모델이 없음`
- 결과: 신규 예측 파이프라인이 해당 ID에서 진행되지 않고 정체.

## 2) 왜 계속 정체됐는지 (핵심 원인)

### A. 직접 원인: 모델 번들 미존재/미등록
- 신규 파이프라인(`predict_visitors.py`)은 `bundle.model_paths`(= `co.BUNDLE_SCHEMA.co.paths`)에서 `id`별 `save_path`를 조회한 뒤 번들을 로드함.
- `tg_47150_010`은 조회 결과가 비어 있어(`NO_ROW`) 곧바로 실패.
- 파일 시스템에도 번들 파일이 없었음:
  - `models/bundles/tg_47150_010_bundle_v1.0.pkl` 부재 확인.

### B. 운영 원인: 복구 실행보다 상태/알림 루프가 앞섬
- 정체 초기 구간에서 "원인 확정 → 번들 생성+등록" 대신 상태 보고/알림 처리 비중이 높아짐.
- 결과적으로 실질 복구 단계(학습/등록)가 늦어짐.

### C. 환경 원인: 실행 경로 의존성
- 기본 실행 시 `weather_kma_api` import 경로 이슈가 발생.
- `PYTHONPATH=src:src/learning_core/integrations` 보정이 필요함.

## 3) 지금까지 실제로 시도한 것 (노력/진행 내역)

### 3-1. 재현 및 원인 고정
- 신규 경로 재현:
  - `src/predict_visitors.py --id tg_47150_010 --days 1`
  - 실패 문구 동일 재현 완료.

### 3-2. 서비스 연속성 확보 (임시 우회)
- `predict_visitors_old.py`로 단일 ID 생성/업로드 수행.
- `gcp/variable_data/260221~260223/tg_47150_010.json` 생성 확인 및 GCS 업로드 확인.
- 의미: 사용자 측 산출물 공백 최소화(단, 근본 해결은 아님).

### 3-3. 근본 복구 착수 (진행 중)
- 목표: `tg_47150_010` 단일 번들 생성 + DB `model_paths` 등록 + 신규 경로 성공 검증.
- 현재 학습 프로세스 실행 중(`cmdstanpy` 체인 로그 확인됨).
- 아직 완료 시점 기준으로는 DB row/번들 파일 생성 전 단계.

## 4) 해결 방향 (정상화 계획)

## 4-1. 즉시 조치 (오늘)
1. 단일 ID 학습 완료까지 대기/모니터링
2. 번들 파일 생성 확인
3. `bundle.model_paths` 업서트(없으면 생성 후 upsert)
4. 신규 `predict_visitors.py --id tg_47150_010 --days 1` 성공 검증
5. 동일 커맨드 3회 연속 검증(GO-3 카운팅 규칙 적용)
   - PASS 3연속 필요
   - FAIL 1회라도 0/3 리셋

## 4-2. 재발 방지 (구조 개선)
1. **사전 게이트** 추가
   - 예측 실행 전 `model_paths row 존재 + save_path 파일 존재`를 먼저 검사.
   - 둘 중 하나라도 없으면 즉시 "학습/등록 단계"로 자동 분기.
2. **단일 ID 복구 스크립트** 고정
   - `id`를 받아 번들 생성→등록→신규예측 검증까지 원샷 처리.
3. **진행 보고 품질 규칙** 고정
   - 알림 문구 전송 금지, 실제 실행 커맨드/성공·실패 기반 수치만 보고.
4. **운영 체크리스트 문서화**
   - 장애 시 우선순위: 재현→근본원인→복구실행→검증→보고.

## 5) 재현/검증 커맨드 세트

```bash
# 1) 신규 경로 재현 (실패 확인)
cd /Users/seongwonseo/Documents/projects/predictourist-learning
PYTHONPATH=src:src/learning_core/integrations .venv/bin/python src/predict_visitors.py --id tg_47150_010 --days 1

# 2) 임시 산출물 확보 (old 경로)
PYTHONPATH=src:src/learning_core/integrations .venv/bin/python src/predict_visitors_old.py --id tg_47150_010 --days 1

# 3) DB 등록 상태 확인
PYTHONPATH=src:src/learning_core/integrations .venv/bin/python - <<'PY'
import pandas as pd, config as co
code='tg_47150_010'
df=pd.read_sql(f"select * from {co.BUNDLE_SCHEMA}.{co.paths} where id='{code}'", co.engine)
print(df if not df.empty else 'NO_ROW')
PY

# 4) 번들 파일 확인
ls -l models/bundles/tg_47150_010_bundle_v1.0.pkl
```

## 6) 현재 상태 결론
- 정체 원인은 확정됨: **번들 미생성/미등록**.
- 복구 방향도 확정됨: **단일 ID 번들 생성+등록 후 신규 경로 성공 검증**.
- 현재는 그 근본 복구를 실제 실행 중이며, 완료 즉시 결과(성공/실패, 로그, GO-3 카운트)를 업데이트해야 함.
